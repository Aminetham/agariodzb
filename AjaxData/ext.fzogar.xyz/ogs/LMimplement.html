<?php 
session_start();
error_reporting(E_ALL | E_WARNING);
require_once __DIR__.'http://ext.fzogar.xyz/ogs/core/Vendor.php';
new Vendor(['config'], true);
new Config();
?>
<!doctype html>
<html>
	<head>
		<title> OGAR Setting </title>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Raleway:400,500,600|Noto+Sans" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.5.3/css/bootstrapValidator.css" >
		<link rel="stylesheet" href="http://ext.fzogar.xyz/ogs/assets/css/jsoneditor.min.css?s">
		<style>
		body {
    		font-family: Noto Sans;
		}
		.bg {
		    position: fixed;
		    width: 100%;
		    height: 100%;
		    background: url(http://ext.fzogar.xyz/ogs/bg.jpg);
		    background-size: cover;
		}
		.center {
			padding: 25px;
		    width: 550px;
			height: 650px;
		    top: 50%;
		    left: 50%;
		    border-radius: 3px;
		    position: fixed;
		    transform: translate(-50%,-50%);
		    background-color: rgb(49, 17, 38);
		    color: #fbdcb8;
		    border-bottom: 2px solid #fbdcb8;
		    box-shadow: 0px 4px 10px rgb(33, 16, 35);
			overflow: auto;
			overflow-x: hidden;
		}
		.center::-webkit-scrollbar {
			width: 0px;
		}
		.g-recaptcha {
		    margin-bottom: 15px;
		}
		label {
		    font-weight: 400 !important;
		}
		#setting {
		    padding: 5px;
		}
		.header {
			display: block;
			float: left;
			clear: both;
		    width: 100%;
		    padding: 9px;
		    position: absolute !important;
		    margin-bottom: 20px;
		    font-size: 21px;
		    line-height: inherit;
		    text-align: center;
		    color: #fbdcb8;
		    border: 0;
		    background: linear-gradient(to left, #e47033, #f89633);
		    font-family: Noto Sans;
		    top: -10px;
			margin-left: -25px;
		    border-radius: 3px;
		    box-shadow: 0px 4px 16px rgba(70, 21, 42, 0.56);
		    z-index:99999;
		}
		input.form-control, textarea.settings{
		    background: #fbdcb8;
		    border: none;
		    border-radius: 1px;
		}
		
		div#jsoneditor {
			background: #fbdcb8;
		    border: none;
		    border-radius: 1px; 
			width: 100% !important;
			height: 250px;
			resize: vertical !important;
		}
		
		
		#upload-button {
		    background: linear-gradient(to left, #e47033, #f89633);
		    border: none;
		    border-radius: 2px;
		    color: #211023;
		}
		.unicode {
		    position: fixed;
		    bottom: 5px;
		    transform: translateX(-50%);
		    left: 50%;
		    color: #fbdcb8;
		    text-transform: uppercase;
		    background: linear-gradient(to left, #c5571e, #de7811);
		    padding: 10px;
		    border-radius: 3px;
		    box-shadow: 0px 0px 5px #110913;
		}
		.unicode:hover {
			text-decoration: none;
		    color: #fbdcb8;
		    background: linear-gradient(to left, #984317, #bd660e);
		}
		.unicode:visited, .unicode:active, .unicode:focus {
			text-decoration: none;
		    color: #fbdcb8;
		}
		</style>
		<!--Jquery-->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="http://ext.fzogar.xyz/ogs/assets/js/jsoneditor.min.js" type="text/javascript"></script>
	</head>
	<body>
		<div class="bg"></div>
		<div class="center" >
		<div class="header">SETTINGS</div><br/>
			<form id="login_form" class='f_login' method='post' enctype="multipart/form-data" autocomplete="off">
				<fieldset>

					<div id="login">
						<div class="form-group ">
							<label for="username">USERNAME</label>
							<input type="text" name="username" class="form-control" value=""  placeholder="..." autocomplete="off">
						</div>
						
						<div class="form-group ">
							<label for="password">PASSWORD</label>
							<input type="password" class="form-control" value="" name="password" placeholder="..." autocomplete="off">
						</div>
						<div class="form-group " id='captcha'>
							<label for="setting">HUMAN VERIFICATION</label>
							<div class="g-recaptcha" data-sitekey="6LdZN0IUAAAAAEI2X-MkP78TUzJqUTp0nMGTx8UU" data-theme="dark"></div>
						</div>
						<div class="form-group">
							<button onclick="login(); return false"class='btn btn-default' title="Logging in will retrieve your saved settings">Login</button> 
							<button onclick="register(); return false"class='btn btn-default' title="Logging in will retrieve your saved settings">Register</button> 
						</div>
					</div>
					

				</fieldset>
			</form>
			<form id="upload_form" class='f_upload' method="post" style="display:none" >
				<fieldset>
						<div class="jjsoneditor form-group">
							<label>SETTINGS (<code class='username'></code>)</label>
							<div id="jsoneditor" style="width: 100%; height: 250px"></div>
							<button class='dojsonupdate btn btn-default' onclick='showpaste(); return false'>Paste</button>
							<button class='dojsonupdate btn btn-default' onclick='copy(); return false'>Copy</button>
						</div>
						
						<div class="jsonupdatediv form-group" style='display: none;'>
							<label >PASTE</label>
							<textarea id="jsonupdate" style='resize: vertical !important; background: #fbdcb8; width: 100%; height: 250px; color: black !important; font-family: Profont'>{}</textarea>
							<button class='jsonupdate btn btn-default' onclick='updatejson(); return false;'>Update</button>
							<button class='btn btn-default' onclick='clearjson(); return false;'>Clear</button>
						</div>
				

						<input type="submit" id="upload-button" class="btn btn-default " value="UPLOAD">
				</fieldset>
			<div id="keyfield">
			<hr/>
			<center>
				Key used to retrieve settings from extension<br/>
				<textarea  class='userkey' oncontextmenu='copykey(); return false;' title='Right click to copy'></textarea>
				</center>
			</div>
				
			</form>

		</div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.5.3/js/bootstrapValidator.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js"></script>
		
		<script>
// ==ClosureCompiler==
// @output_file_name default.js
// @compilation_level SIMPLE_OPTIMIZATIONS
// ==/ClosureCompiler==
(function(w) {
	var udate = null;
    var container = document.getElementById('jsoneditor'), editor = new JSONEditor(container, {
		name: "Settings",
		escapeUnicode: true,
		sortObjectKeys: true,
		indentation: 2
	});
	
	var isLoggedIn = false;
	
	var paste = document.getElementById('jsonupdate');
	
	function update(a){
		
		try{
			var parse = JSON.parse(paste.value);
			editor.set(parse);
			w.showeditor();
		}catch(e){
			if(!a) alert("Failed to parse settings. > " + e);
		}
	}
	
	w.copykey = function(){
		$('.userkey').select();
		var status = document.execCommand('Copy');
		if(status) return alert('Key copied');
		return alert('Failed to copy key');
	}
	
    w.updatejson = function(a) {
		update(a);
		return;
    }

    w.showeditor = function() {
		if(!isLoggedIn) return;
        $(".jsonupdatediv").hide();
        $(".jjsoneditor").fadeIn('slow');
    }

    w.showpaste = function() {
		if(!isLoggedIn) return;
		paste.value = JSON.stringify(editor.get());
        $(".jjsoneditor").hide();
        $(".jsonupdatediv").fadeIn('slow');
    }

	w.clearjson = function(){
		paste.value = "{}";
	}
	
    function login() {
		if(isLoggedIn) return;
		isLoggedIn = true;
		
        $("#login_form").remove();
        $("#upload_form").fadeIn('slow');
    }

    w.register = function() {
        var data = getData();

        if (data.username.length < 4 || data.username.length > 12) return alert('Username length must be 4-12');
        if (data.password.length < 4 || data.username.length > 24) return alert('Password length must be 4-24');

        $.ajax({
            url: 'http://ext.fzogar.xyz/ogs/',
            type: 'POST',
            dataType: 'json',
            data: {
                action: 'register',
                data: data
            },
            success: function(e) {
                if (e && e.status && e.data) {
                    if (e.data.json) {
                        // continue
                        editor.set(JSON.parse(e.data.json));
                        $('.username').html(e.data.username);
                        return showeditor();
                    } else {
                        grecaptcha.reset();
                        return alert(e.data);
                    }
                } else {
                    grecaptcha.reset();
                    if (e && e.data) {
                        return alert(e.data);
                    }
                    return alert('an error has occured');
                }
            },
            error: function(e) {
                alert('an error has occured : ' + e);
            }
        });
    }

    w.login = function() {
        var data = getData();
        if (data.username.length < 4 || data.username.length > 12) return alert('Username length must be 4-12');
        if (data.password.length < 4 || data.username.length > 24) return alert('Password length must be 4-24');
        $.ajax({
            url: 'http://ext.fzogar.xyz/ogs/',
            type: 'POST',
            dataType: 'json',
            data: {
                action: 'login',
                data: data
            },
            success: function(e) {
                if (e && e.status && e.data) {
                    if (e.data.json) {
                        // continue
                        editor.set(JSON.parse(e.data.json));
                        $("#jsonupdate").val(e.data.json);
						$('.userkey').val(e.data.data.key);
                        $('.username').html(e.data.data.username);
                        return login();
                    } else {
                        grecaptcha.reset();
                        return alert(e.data);
                    }
                } else {
                    grecaptcha.reset();
                    if (e && e.data) {
                        return alert(e.data);
                    }
                    return alert('an error has occured');
                }
            },
            error: function(e) {
                alert('an error has occured : ' + e);
                console.error(e);
            }
        });
    }

    function getData() {
        var data = {};
        $("#login_form").serializeArray().map(function(x) {
            data[x.name] = x.value
        });
        return data;
    }

	w.getData = function(){
		return editor.get();
	}
	
    w.copy = function() {
        window.showpaste();
        paste.value = JSON.stringify(editor.get());
        paste.select();
        var status = document.execCommand("Copy");
        window.showeditor();
        if (status) return alert('copied');
        return alert('Failed to copy');
    }

    w.onload = function() {
		return;
        $.ajax({
            url: "/ogs/settings.json",
            type: "GET",
            dataType: "json",
            success: function(e) {
                editor.set(e);
				update();
            }
        })
    }

	
    $('#upload_form').on('submit', function(e) {
        e.preventDefault();
        var data = {};
        $(this).serializeArray().map(function(x) {
            data[x.name] = x.value
        });
        data.settings = JSON.stringify(editor.get());
        $.ajax({
            url: 'http://ext.fzogar.xyz/ogs/',
            type: 'POST',
            dataType: 'json',
            data: {
                action: 'update',
                data: data
            },
            success: function(e) {
                if (e && e.status && e.data) {
					editor.set(e.data.json);
					return alert('Settings saved');
                    // return alert(e.data);
                } else {
                    if (e && e.data) {
                        return alert(e.data);
                    }
                    return alert('an error has occured');
                }
            },
            error: function(e) {
                console.error(e);
            }
        });
    })

})(window);
		</script>
		
	</body>
</html>
